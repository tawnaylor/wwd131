<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>The Family Bookshelf</title>
  <link rel="stylesheet" href="blog.css" />
</head>
<body>

  <header>
    <h1>The Family Bookshelf</h1>
    <nav>
      <a href="#">About</a>
      <a href="#">Library Link</a>
      <a href="#">Bookshelf</a>
      <a href="#">Social Media</a>
    </nav>
  </header>

  <!-- Book Search Modal -->
  <div id="bookSearchModal" class="modal" style="display:none;">
    <div class="modal-content modal-center" style="max-width:500px;">
      <span class="close" id="closeBookSearchModalBtn">&times;</span>
      <h3>Search for a Book</h3>
      <input type="text" id="searchInput" placeholder="Search for a book..." style="width:100%;margin-bottom:8px;" />
      <button id="searchBooksBtn" style="margin-bottom:12px;">Search Books</button>
      <div class="results" id="resultsContainer"></div>
    </div>
  </div>

  <div style="text-align:center; margin-bottom: 20px;">
    <button id="showBookModalBtn">Submit Book</button>
    <button id="showBookSearchModalBtn">Book Search</button>
  </div>

  <!-- Book Submission Modal -->
  <div id="bookModal" class="modal" style="display:none;">
    <div class="modal-content modal-center">
      <span class="close" id="closeBookModalBtn">&times;</span>
      <h3>Submit a New Book</h3>
      <input id="bookTitle" type="text" style="width:100%;margin-bottom:8px;" placeholder="Book Title" />
      <input id="bookAuthor" type="text" style="width:100%;margin-bottom:8px;" placeholder="Author" />
      <input id="bookGenre" type="text" style="width:100%;margin-bottom:8px;" placeholder="Genre" />
      <input id="bookCover" type="text" style="width:100%;margin-bottom:8px;" placeholder="Cover Image URL (optional)" />
      <button id="submitBookBtn">Submit Book</button>
    </div>
  </div>

  <hr class="page-divider" />

  <div id="bookReviewContainer">
    <section class="book-review-section">
      <div class="review-buttons">
        <button>Parents Review</button>
        <button>Kids Review</button>
      </div>
      <div class="book-cover-image">
        <img src="images/PVN-L-CHARLOTTE-0229-cover.webp" alt="Charlotte's Web" />
      </div>
      <div class="book-info-panel">
        <h2>Charlotte's Web</h2>
        <p><strong>Author:</strong> E. B. White</p>
        <p><strong>Genre:</strong> Children's Fiction</p>
        <p><strong>Date of Submission:</strong> 2024-05-01</p>
        <p><strong>Average Rating:</strong> ★★★★★</p>
      </div>
    </section>
    <div class="submitted-reviews">
      <div class="parent-review">
        <div class="review-header">
          <span class="review-user">MomOf3</span>
          <span class="review-stars">★★★★★</span>
        </div>
        <div>This book is a timeless classic! We loved reading it together as a family. The story of friendship and kindness is perfect for all ages.</div>
      </div>
      <div class="kids-review">
        <div class="review-header">
          <span class="review-user">Ella (age 8)</span>
          <span class="review-stars">★★★★★</span>
        </div>
        <div>I liked Wilbur and Charlotte! The ending made me cry but it was happy too. I want a pig for a pet now!</div>
      </div>
    </div>
    <hr class="review-divider" />

    <section class="book-review-section">
      <div class="review-buttons">
        <button>Parents Review</button>
        <button>Kids Review</button>
      </div>
      <div class="book-cover-image">
        <img src="images/71-++hbbERL.jpg" alt="Harry Potter and the Sorcerer's Stone" />
      </div>
      <div class="book-info-panel">
        <h2>Harry Potter and the Sorcerer's Stone</h2>
        <p><strong>Author:</strong> J.K. Rowling</p>
        <p><strong>Genre:</strong> Fantasy</p>
        <p><strong>Date of Submission:</strong> 2024-05-01</p>
        <p><strong>Average Rating:</strong> ★★★★☆</p>
      </div>
    </section>
    <div class="submitted-reviews">
      <div class="parent-review">
        <div class="review-header">
          <span class="review-user">DadReads</span>
          <span class="review-stars">★★★★☆</span>
        </div>
        <div>Great adventure and imagination! We read a chapter every night. Some parts are a little scary for younger kids, but overall a magical experience.</div>
      </div>
      <div class="kids-review">
        <div class="review-header">
          <span class="review-user">Ben (age 10)</span>
          <span class="review-stars">★★★★★</span>
        </div>
        <div>I wish I could go to Hogwarts! My favorite part was when Harry played Quidditch. I want to read the next book!</div>
      </div>
    </div>
    <hr class="review-divider" />

    <section class="book-review-section">
      <div class="review-buttons">
        <button>Parents Review</button>
        <button>Kids Review</button>
      </div>
      <div class="book-cover-image">
        <img src="images/tvhcbook-2.webp" alt="The Very Hungry Caterpillar" />
      </div>
      <div class="book-info-panel">
        <h2>The Very Hungry Caterpillar</h2>
        <p><strong>Author:</strong> Eric Carle</p>
        <p><strong>Genre:</strong> Picture Book</p>
        <p><strong>Date of Submission:</strong> 2024-05-01</p>
        <p><strong>Average Rating:</strong> ★★★★★</p>
      </div>
    </section>
    <div class="submitted-reviews">
      <div class="parent-review">
        <div class="review-header">
          <span class="review-user">BookwormFamily</span>
          <span class="review-stars">★★★★★</span>
        </div>
        <div>Perfect for bedtime! The illustrations are beautiful and the story is simple and fun. My toddler loves turning the pages and counting the foods.</div>
      </div>
      <div class="kids-review">
        <div class="review-header">
          <span class="review-user">Sammy (age 4)</span>
          <span class="review-stars">★★★★★</span>
        </div>
        <div>The caterpillar eats so much! I like the butterfly at the end. Can we read it again?</div>
      </div>
    </div>
    <hr class="review-divider" />
  </div>

  <footer></footer>
    <div class="footer-left">
      <strong>Logo</strong>
    </div>
    <nav class="footer-nav">
      <a href="#">About</a>
      <a href="#">Library Link</a>
      <a href="#">Bookshelf</a>
      <a href="#">Social Media</a>
    </nav>
    <div class="footer-right">
      <span>© 2024 Your Website. All rights reserved.</span>
      <a href="#">Privacy Policy</a>
      <a href="#">Terms of Service</a>
    </div>
    <div class="social-icons">
      <span>📸</span><span>📘</span><span>🐦</span>
    </div>
  </footer>

  <!-- Parent Review Modal -->
  <div id="parentReviewModal" class="modal" style="display:none;">
    <div class="modal-content modal-center">
      <span class="close" id="closeModalBtn">&times;</span>
      <h3>Submit Parent Review</h3>
      <input id="parentReviewUser" type="text" style="width:100%;margin-bottom:8px;" placeholder="Your name" />
      <div style="margin-bottom:8px;">
        <label>Rating: </label>
        <select id="parentReviewStars">
          <option value="1">★☆☆☆☆</option>
          <option value="2">★★☆☆☆</option>
          <option value="3">★★★☆☆</option>
          <option value="4">★★★★☆</option>
          <option value="5">★★★★★</option>
        </select>
      </div>
      <textarea id="parentReviewText" rows="5" style="width:100%;" placeholder="Write your review here..."></textarea>
      <br>
      <button id="submitParentReviewBtn">Submit Review</button>
    </div>
  </div>

  <!-- Kids Review Modal -->
  <div id="kidsReviewModal" class="modal" style="display:none;">
    <div class="modal-content modal-center">
      <span class="close" id="closeKidsModalBtn">&times;</span>
      <h3>Submit Kids Review</h3>
      <input id="kidsReviewUser" type="text" style="width:100%;margin-bottom:8px;" placeholder="Your name" />
      <div style="margin-bottom:8px;">
        <label>Rating: </label>
        <select id="kidsReviewStars">
          <option value="1">★☆☆☆☆</option>
          <option value="2">★★☆☆☆</option>
          <option value="3">★★★☆☆</option>
          <option value="4">★★★★☆</option>
          <option value="5">★★★★★</option>
        </select>
      </div>
      <textarea id="kidsReviewText" rows="5" style="width:100%;" placeholder="Write your review here..."></textarea>
      <br>
      <button id="submitKidsReviewBtn">Submit Review</button>
    </div>
  </div>

  <script>
    let currentReviewTarget = null;

    // Parent Review Button
    document.querySelectorAll('.review-buttons button:first-child').forEach(btn => {
      btn.addEventListener('click', function() {
        currentReviewTarget = this.closest('.book-review-section').nextElementSibling;
        document.getElementById('parentReviewModal').style.display = 'block';
        document.getElementById('parentReviewText').value = '';
        document.getElementById('parentReviewUser').value = '';
        document.getElementById('parentReviewStars').value = '5';
      });
    });

    // Kids Review Button
    document.querySelectorAll('.review-buttons button:last-child').forEach(btn => {
      btn.addEventListener('click', function() {
        currentReviewTarget = this.closest('.book-review-section').nextElementSibling;
        document.getElementById('kidsReviewModal').style.display = 'block';
        document.getElementById('kidsReviewText').value = '';
        document.getElementById('kidsReviewUser').value = '';
        document.getElementById('kidsReviewStars').value = '5';
      });
    });

    // Close modals
    document.getElementById('closeModalBtn').onclick = function() {
      document.getElementById('parentReviewModal').style.display = 'none';
    };
    document.getElementById('closeKidsModalBtn').onclick = function() {
      document.getElementById('kidsReviewModal').style.display = 'none';
    };

    // Submit Parent Review
    document.getElementById('submitParentReviewBtn').onclick = function() {
      const text = document.getElementById('parentReviewText').value.trim();
      const user = document.getElementById('parentReviewUser').value.trim() || "Anonymous";
      const stars = document.getElementById('parentReviewStars').value;
      if (text && currentReviewTarget) {
        const reviewDiv = document.createElement('div');
        reviewDiv.className = 'parent-review';
        reviewDiv.innerHTML = `<div class="review-header"><span class="review-user">${user}</span> <span class="review-stars">${'★'.repeat(stars)}${'☆'.repeat(5-stars)}</span></div><div>${text}</div>`;
        currentReviewTarget.appendChild(reviewDiv);
        document.getElementById('parentReviewModal').style.display = 'none';
      }
    };

    // Submit Kids Review
    document.getElementById('submitKidsReviewBtn').onclick = function() {
      const text = document.getElementById('kidsReviewText').value.trim();
      const user = document.getElementById('kidsReviewUser').value.trim() || "Anonymous";
      const stars = document.getElementById('kidsReviewStars').value;
      if (text && currentReviewTarget) {
        const reviewDiv = document.createElement('div');
        reviewDiv.className = 'kids-review';
        reviewDiv.innerHTML = `<div class="review-header"><span class="review-user">${user}</span> <span class="review-stars">${'★'.repeat(stars)}${'☆'.repeat(5-stars)}</span></div><div>${text}</div>`;
        currentReviewTarget.appendChild(reviewDiv);
        document.getElementById('kidsReviewModal').style.display = 'none';
      }
    };

    // Book Modal logic
    document.getElementById('showBookModalBtn').onclick = function() {
      document.getElementById('bookModal').style.display = 'flex';
      document.getElementById('bookTitle').value = '';
      document.getElementById('bookAuthor').value = '';
      document.getElementById('bookGenre').value = '';
      document.getElementById('bookCover').value = '';
    };
    document.getElementById('closeBookModalBtn').onclick = function() {
      document.getElementById('bookModal').style.display = 'none';
    };

    document.getElementById('submitBookBtn').onclick = function() {
      const title = document.getElementById('bookTitle').value.trim() || "Untitled";
      const author = document.getElementById('bookAuthor').value.trim() || "Unknown";
      const genre = document.getElementById('bookGenre').value.trim() || "Unknown";
      const cover = document.getElementById('bookCover').value.trim() || "https://via.placeholder.com/150x220?text=Book+Cover";
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // Create new book review section
      const section = document.createElement('section');
      section.className = 'book-review-section';
      section.innerHTML = `
        <div class="review-buttons">
          <button>Parents Review</button>
          <button>Kids Review</button>
        </div>
        <div class="book-cover-image">
          <img src="${cover}" alt="Book Cover" />
        </div>
        <div class="book-info-panel">
          <h2>${title}</h2>
          <p><strong>Author:</strong> ${author}</p>
          <p><strong>Genre:</strong> ${genre}</p>
          <p><strong>Date of Submission:</strong> ${dateStr}</p>
          <p><strong>Average Rating:</strong> ★★★★☆</p>
        </div>
      `;
      const reviewsDiv = document.createElement('div');
      reviewsDiv.className = 'submitted-reviews';

      // Add to DOM
      document.getElementById('bookReviewContainer').appendChild(section);
      document.getElementById('bookReviewContainer').appendChild(reviewsDiv);

      // Add event listeners for new review buttons
      section.querySelector('.review-buttons button:first-child').addEventListener('click', function() {
        currentReviewTarget = section.nextElementSibling;
        document.getElementById('parentReviewModal').style.display = 'block';
        document.getElementById('parentReviewText').value = '';
        document.getElementById('parentReviewUser').value = '';
        document.getElementById('parentReviewStars').value = '5';
      });
      section.querySelector('.review-buttons button:last-child').addEventListener('click', function() {
        currentReviewTarget = section.nextElementSibling;
        document.getElementById('kidsReviewModal').style.display = 'block';
        document.getElementById('kidsReviewText').value = '';
        document.getElementById('kidsReviewUser').value = '';
        document.getElementById('kidsReviewStars').value = '5';
      });

      document.getElementById('bookModal').style.display = 'none';
    };

    // Book Search Modal logic
    document.getElementById('showBookSearchModalBtn').onclick = function() {
      document.getElementById('bookSearchModal').style.display = 'flex';
      document.getElementById('searchInput').value = '';
      document.getElementById('resultsContainer').innerHTML = '';
    };
    document.getElementById('closeBookSearchModalBtn').onclick = function() {
      document.getElementById('bookSearchModal').style.display = 'none';
    };

    // Google Books Search - now works in the modal
    document.getElementById("searchBooksBtn").onclick = searchBooks;

    // Show reviews if search is cleared in modal
    document.getElementById("searchInput").addEventListener("input", function() {
      const resultsContainer = document.getElementById("resultsContainer");
      if (this.value.trim() === "") {
        resultsContainer.innerHTML = "";
      }
    });

    async function searchBooks() {
      const query = document.getElementById("searchInput").value.trim();
      const resultsContainer = document.getElementById("resultsContainer");
      resultsContainer.innerHTML = "";

      if (!query) {
        resultsContainer.innerHTML = "<p>Please enter a search term.</p>";
        return;
      }

      const response = await fetch(
        `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`
      );

      const data = await response.json();

      if (!data.items || data.items.length === 0) {
        resultsContainer.innerHTML = "<p>No results found.</p>";
        return;
      }

      data.items.forEach(item => {
        const book = item.volumeInfo;
        const title = book.title || "No title";
        const authors = book.authors ? book.authors.join(", ") : "Unknown author";
        const thumbnail = book.imageLinks?.thumbnail || "";

        const bookDiv = document.createElement("div");
        bookDiv.classList.add("book");
        bookDiv.style.marginBottom = "16px";
        bookDiv.innerHTML = `
          <h3>${title}</h3>
          <p><strong>Author(s):</strong> ${authors}</p>
          ${thumbnail ? `<img src="${thumbnail}" alt="${title}" style="max-width:100px;"/>` : ""}
          <br>
          <button class="submit-found-book-btn">Submit This Book</button>
        `;
        // Add submit event for this book
        bookDiv.querySelector('.submit-found-book-btn').onclick = function() {
          // Prefill the submit book modal with found book info
          document.getElementById('bookTitle').value = title;
          document.getElementById('bookAuthor').value = authors;
          document.getElementById('bookGenre').value = book.categories ? book.categories.join(", ") : "";
          document.getElementById('bookCover').value = thumbnail;
          document.getElementById('bookModal').style.display = 'flex';
          document.getElementById('bookSearchModal').style.display = 'none';
        };
        resultsContainer.appendChild(bookDiv);
      });
    }

    // Optional: Close modal when clicking outside modal content
    window.onclick = function(event) {
      const parentModal = document.getElementById('parentReviewModal');
      const kidsModal = document.getElementById('kidsReviewModal');
      if (event.target === parentModal) {
        parentModal.style.display = 'none';
      }
      if (event.target === kidsModal) {
        kidsModal.style.display = 'none';
      }
    };

    // --- Persistence helpers ---
    function saveBooksToStorage() {
      const books = [];
      document.querySelectorAll('.book-review-section').forEach((section) => {
        const info = section.querySelector('.book-info-panel');
        const title = info.querySelector('h2').textContent;
        const author = info.querySelector('p:nth-child(2)').textContent.replace('Author:', '').trim();
        const genre = info.querySelector('p:nth-child(3)').textContent.replace('Genre:', '').trim();
        const date = info.querySelector('p:nth-child(4)').textContent.replace('Date of Submission:', '').trim();
        const avg = info.querySelector('p:nth-child(5)').textContent.replace('Average Rating:', '').trim();
        const cover = section.querySelector('.book-cover-image img').getAttribute('src');
        // Reviews
        const reviewsDiv = section.nextElementSibling;
        const reviews = [];
        reviewsDiv.querySelectorAll('.parent-review, .kids-review').forEach(r => {
          reviews.push({
            type: r.classList.contains('parent-review') ? 'parent' : 'kids',
            html: r.innerHTML
          });
        });
        books.push({ title, author, genre, date, avg, cover, reviews });
      });
      localStorage.setItem('bookshelf_books', JSON.stringify(books));
    }

    function loadBooksFromStorage() {
      const books = JSON.parse(localStorage.getItem('bookshelf_books') || '[]');
      const container = document.getElementById('bookReviewContainer');
      container.innerHTML = '';
      books.forEach(book => {
        const section = document.createElement('section');
        section.className = 'book-review-section';
        section.innerHTML = `
          <div class="review-buttons">
            <button>Parents Review</button>
            <button>Kids Review</button>
          </div>
          <div class="book-cover-image">
            <img src="${book.cover}" alt="Book Cover" />
          </div>
          <div class="book-info-panel">
            <h2>${book.title}</h2>
            <p><strong>Author:</strong> ${book.author}</p>
            <p><strong>Genre:</strong> ${book.genre}</p>
            <p><strong>Date of Submission:</strong> ${book.date}</p>
            <p><strong>Average Rating:</strong> ${book.avg}</p>
          </div>
        `;
        const reviewsDiv = document.createElement('div');
        reviewsDiv.className = 'submitted-reviews';
        (book.reviews || []).forEach(r => {
          const div = document.createElement('div');
          div.className = r.type === 'parent' ? 'parent-review' : 'kids-review';
          div.innerHTML = r.html;
          reviewsDiv.appendChild(div);
        });
        // Insert at the end to preserve order (oldest at bottom, newest at top)
        container.appendChild(section);
        container.appendChild(reviewsDiv);
        // Add event listeners for review buttons
        section.querySelector('.review-buttons button:first-child').addEventListener('click', function() {
          currentReviewTarget = section.nextElementSibling;
          document.getElementById('parentReviewModal').style.display = 'block';
          document.getElementById('parentReviewText').value = '';
          document.getElementById('parentReviewUser').value = '';
          document.getElementById('parentReviewStars').value = '5';
        });
        section.querySelector('.review-buttons button:last-child').addEventListener('click', function() {
          currentReviewTarget = section.nextElementSibling;
          document.getElementById('kidsReviewModal').style.display = 'block';
          document.getElementById('kidsReviewText').value = '';
          document.getElementById('kidsReviewUser').value = '';
          document.getElementById('kidsReviewStars').value = '5';
        });
        // Divider
        const divider = document.createElement('hr');
        divider.className = 'review-divider';
        container.appendChild(divider);
      });
    }

    // --- Patch all book/review creation to save ---
    function patchSaveOnBookAdd() {
      // Patch book submission
      const origSubmitBookBtn = document.getElementById('submitBookBtn').onclick;
      document.getElementById('submitBookBtn').onclick = function() {
        if (origSubmitBookBtn) origSubmitBookBtn();
        setTimeout(saveBooksToStorage, 100);
      };
      // Patch review submission
      const origSubmitParentReviewBtn = document.getElementById('submitParentReviewBtn').onclick;
      document.getElementById('submitParentReviewBtn').onclick = function() {
        if (origSubmitParentReviewBtn) origSubmitParentReviewBtn();
        setTimeout(saveBooksToStorage, 100);
      };
      const origSubmitKidsReviewBtn = document.getElementById('submitKidsReviewBtn').onclick;
      document.getElementById('submitKidsReviewBtn').onclick = function() {
        if (origSubmitKidsReviewBtn) origSubmitKidsReviewBtn();
        setTimeout(saveBooksToStorage, 100);
      };
    }

    // --- On page load, load books/reviews from storage ---
    window.addEventListener('DOMContentLoaded', function() {
      loadBooksFromStorage();
      patchSaveOnBookAdd();
    });

    // --- After any Google Books submission, save ---
    let origSearchBooks = window.searchBooks;
    window.searchBooks = async function() {
      if (origSearchBooks) await origSearchBooks();
      // Patch submit buttons in search results
      document.querySelectorAll('.submit-found-book-btn').forEach(btn => {
        btn.onclick = function() {
          document.getElementById('bookTitle').value = btn.parentElement.querySelector('h3').textContent;
          document.getElementById('bookAuthor').value = btn.parentElement.querySelector('p').textContent.replace('Author(s):', '').trim();
          document.getElementById('bookGenre').value = '';
          const img = btn.parentElement.querySelector('img');
          document.getElementById('bookCover').value = img ? img.src : '';
          document.getElementById('bookModal').style.display = 'flex';
          document.getElementById('bookSearchModal').style.display = 'none';
          // Save after book is submitted (handled by patchSaveOnBookAdd)
        };
      });
    }

    // --- Insert new book at the top and save ---
    // Patch the book submission logic to insert at the top
    const origBookBtn = document.getElementById('submitBookBtn').onclick;
    document.getElementById('submitBookBtn').onclick = function() {
      const title = document.getElementById('bookTitle').value.trim() || "Untitled";
      const author = document.getElementById('bookAuthor').value.trim() || "Unknown";
      const genre = document.getElementById('bookGenre').value.trim() || "Unknown";
      const cover = document.getElementById('bookCover').value.trim() || "https://via.placeholder.com/150x220?text=Book+Cover";
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];

      // Create new book review section
      const section = document.createElement('section');
      section.className = 'book-review-section';
      section.innerHTML = `
        <div class="review-buttons">
          <button>Parents Review</button>
          <button>Kids Review</button>
        </div>
        <div class="book-cover-image">
          <img src="${cover}" alt="Book Cover" />
        </div>
        <div class="book-info-panel">
          <h2>${title}</h2>
          <p><strong>Author:</strong> ${author}</p>
          <p><strong>Genre:</strong> ${genre}</p>
          <p><strong>Date of Submission:</strong> ${dateStr}</p>
          <p><strong>Average Rating:</strong> ★★★★☆</p>
        </div>
      `;
      const reviewsDiv = document.createElement('div');
      reviewsDiv.className = 'submitted-reviews';

      // Insert at the top
      const container = document.getElementById('bookReviewContainer');
      container.insertBefore(reviewsDiv, container.firstChild);
      container.insertBefore(section, reviewsDiv);

      // Add event listeners for new review buttons
      section.querySelector('.review-buttons button:first-child').addEventListener('click', function() {
        currentReviewTarget = section.nextElementSibling;
        document.getElementById('parentReviewModal').style.display = 'block';
        document.getElementById('parentReviewText').value = '';
        document.getElementById('parentReviewUser').value = '';
        document.getElementById('parentReviewStars').value = '5';
      });
      section.querySelector('.review-buttons button:last-child').addEventListener('click', function() {
        currentReviewTarget = section.nextElementSibling;
        document.getElementById('kidsReviewModal').style.display = 'block';
        document.getElementById('kidsReviewText').value = '';
        document.getElementById('kidsReviewUser').value = '';
        document.getElementById('kidsReviewStars').value = '5';
      });

      document.getElementById('bookModal').style.display = 'none';
      setTimeout(saveBooksToStorage, 100);
    };
  </script>
</body>
</html>
